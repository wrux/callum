---
import SanityPicture from 'astro-sanity-picture';
import Section from '../Section.astro';
import { imageBuilder } from '~/sanity/image';

export interface Props {
  node: {
    images: {
      caption: string;
      image: ImageWithMeta;
    }[];
  };
}

const { images } = Astro.props.node;
---

<Section width="full" data-block="image-gallery">
  <div class="masonry-grid">
    {
      images.map(({ caption, image }) => (
        <div class="masonry-item rounded-xl overflow-hidden shadow-lg border border-gray-800 relative">
          <SanityPicture
            src={image}
            imageUrlBuilder={imageBuilder}
            style={{
              width: '100%',
              height: 'auto',
            }}
            sizes="(max-width: 767px) calc(100vw - 2rem), (max-width: 1535px) calc(50vw - 3rem), 400px"
            loading="lazy"
            img={{
              alt: image.asset.alt || caption || '',
            }}
          />
          {caption && (
            <div class="absolute bottom-0 left-0 p-4 max-w-[calc(100%-1rem)]">
              <div class="rounded-lg text-white py-3 px-4 text-sm leading-5 bg-black/30 backdrop-blur-[8px] [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]">
                {caption}
              </div>
            </div>
          )}
        </div>
      ))
    }
  </div>
</Section>

<script>
  import Masonry from 'masonry-layout';

  function initMasonryGallery() {
    // Find this specific gallery grid
    const galleryGrids = document.querySelectorAll(
      '[data-block="image-gallery"] .masonry-grid',
    );

    galleryGrids.forEach((gridElement) => {
      const grid = gridElement as HTMLElement;
      // Skip if already initialized
      if (grid.dataset.masonryInitialized === 'true') {
        return;
      }
      grid.dataset.masonryInitialized = 'true';

      // Wait for images to load before initializing Masonry
      const images = gridElement.querySelectorAll('img');
      let loadedImages = 0;
      const totalImages = images.length;

      const initMasonry = () => {
        if (!Masonry) {
          console.error('Masonry library not available');
          return;
        }

        const msnry = new Masonry(gridElement as HTMLElement, {
          itemSelector: '.masonry-item',
          columnWidth: '.masonry-item',
          percentPosition: true,
          gutter: 16,
          transitionDuration: '0.3s',
        });

        if (!msnry) {
          return;
        }

        const layoutMethod = msnry.layout;
        if (!layoutMethod) {
          return;
        }

        // Re-layout when images load
        images.forEach((img) => {
          if (img.complete) {
            layoutMethod.call(msnry);
          } else {
            img.addEventListener('load', () => {
              layoutMethod.call(msnry);
            });
          }
        });
      };

      if (totalImages === 0) {
        initMasonry();
      } else {
        images.forEach((img) => {
          if (img.complete) {
            loadedImages++;
            if (loadedImages === totalImages) {
              initMasonry();
            }
          } else {
            img.addEventListener('load', () => {
              loadedImages++;
              if (loadedImages === totalImages) {
                initMasonry();
              }
            });
          }
        });
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonryGallery);
  } else {
    initMasonryGallery();
  }

  // Also initialize on view transitions (Astro)
  document.addEventListener('astro:after-swap', initMasonryGallery);
</script>

<style scoped>
  .masonry-grid {
    margin: 0 auto;
  }

  .masonry-item {
    width: calc(50% - 8px);
    margin-bottom: 16px;
    break-inside: avoid;
    position: relative;
  }

  @media (max-width: 767px) {
    .masonry-item {
      width: 100%;
    }
  }

  @media (min-width: 1280px) {
    .masonry-item {
      width: calc(33.333% - 11px);
    }
  }
</style>
