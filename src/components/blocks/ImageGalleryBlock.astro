---
import SanityPicture from 'astro-sanity-picture';
import Section from '../Section.astro';
import { imageBuilder } from '~/sanity/image';

export interface Props {
  node: {
    images: {
      caption: string;
      image: ImageWithMeta;
    }[];
  };
}

const { images } = Astro.props.node;
---

<Section width="full" data-block="image-gallery">
  <div class="masonry-grid">
    {
      images.map(({ caption, image }) => (
        <div
          class="masonry-item rounded-xl overflow-hidden shadow-lg border border-gray-800 relative"
          style={{ aspectRatio: image.asset.metadata?.dimensions?.aspectRatio }}
        >
          <SanityPicture
            src={image}
            imageUrlBuilder={imageBuilder}
            style={{
              width: '100%',
              height: '100%',
              objectFit: 'cover',
            }}
            sizes="(max-width: 767px) calc(100vw - 2rem), (max-width: 1535px) calc(50vw - 3rem), 400px"
            loading="lazy"
            img={{
              alt: image.asset.alt || caption || '',
              class: 'w-full h-full object-cover',
            }}
          />
          {caption && (
            <div class="absolute bottom-0 left-0 p-4 max-w-[calc(100%-1rem)]">
              <div class="rounded-lg text-white py-3 px-4 text-sm leading-5 bg-black/30 backdrop-blur-[8px] [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]">
                {caption}
              </div>
            </div>
          )}
        </div>
      ))
    }
  </div>
</Section>

<script>
  import Masonry from 'masonry-layout';

  function initMasonryGallery() {
    // Find this specific gallery grid
    const galleryGrids = document.querySelectorAll(
      '[data-block="image-gallery"] .masonry-grid',
    );

    galleryGrids.forEach((gridElement) => {
      const grid = gridElement as HTMLElement;
      // Skip if already initialized
      if (grid.dataset.masonryInitialized === 'true') {
        return;
      }
      grid.dataset.masonryInitialized = 'true';

      // Initialize Masonry immediately using aspect ratios
      // This prevents layout shift since items have aspect ratios set
      const initMasonry = () => {
        if (!Masonry) {
          console.error('Masonry library not available');
          return;
        }

        const msnry = new Masonry(gridElement as HTMLElement, {
          itemSelector: '.masonry-item',
          columnWidth: '.masonry-item',
          percentPosition: true,
          gutter: 16,
          transitionDuration: '0.3s',
        });

        if (!msnry) {
          return;
        }

        const layoutMethod = msnry.layout;
        if (!layoutMethod) {
          return;
        }

        // Initial layout - items have aspect ratios so this works immediately
        layoutMethod.call(msnry);

        // Re-layout when images load for fine-tuning (images might have slightly different dimensions)
        const images = gridElement.querySelectorAll('img');
        images.forEach((img) => {
          if (!img.complete) {
            img.addEventListener(
              'load',
              () => {
                layoutMethod.call(msnry);
              },
              { once: true },
            );
          }
        });
      };

      // Use requestAnimationFrame to ensure DOM is ready and aspect ratios are applied
      requestAnimationFrame(() => {
        initMasonry();
      });
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonryGallery);
  } else {
    initMasonryGallery();
  }

  // Also initialize on view transitions (Astro)
  document.addEventListener('astro:after-swap', initMasonryGallery);
</script>

<style scoped>
  .masonry-grid {
    margin: 0 auto;
  }

  .masonry-item {
    width: calc(50% - 8px);
    margin-bottom: 16px;
    break-inside: avoid;
    position: relative;
    min-height: 0;
  }

  @media (max-width: 767px) {
    .masonry-item {
      width: 100%;
    }
  }

  @media (min-width: 1280px) {
    .masonry-item {
      width: calc(33.333% - 11px);
    }
  }
</style>
