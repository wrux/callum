---
import SanityPicture from 'astro-sanity-picture';
import Section from '../Section.astro';
import { imageBuilder } from '~/sanity/image';

export interface Props {
  node: {
    images: {
      caption: string;
      image: ImageWithMeta;
    }[];
  };
}

const { images } = Astro.props.node;
---

<Section width="lg" data-block="image-gallery">
  <div class="masonry-grid">
    {
      images.map(({ caption, image }) => (
        <div class="masonry-item rounded-xl overflow-hidden shadow-lg border border-gray-800">
          <SanityPicture
            src={image}
            imageUrlBuilder={imageBuilder}
            style={{
              width: '100%',
              height: 'auto',
            }}
            sizes="(max-width: 767px) calc(100vw - 2rem), (max-width: 1535px) calc(50vw - 3rem), 400px"
            loading="lazy"
            img={{
              alt: image.asset.alt || caption || '',
            }}
          />
        </div>
      ))
    }
  </div>
</Section>

<script>
  import Masonry from 'masonry-layout';

  function initMasonryGallery() {
    // Find this specific gallery grid
    const galleryGrids = document.querySelectorAll(
      '[data-block="image-gallery"] .masonry-grid',
    );

    galleryGrids.forEach((gridElement) => {
      // Skip if already initialized
      if (gridElement.dataset.masonryInitialized === 'true') {
        return;
      }
      gridElement.dataset.masonryInitialized = 'true';

      // Wait for images to load before initializing Masonry
      const images = gridElement.querySelectorAll('img');
      let loadedImages = 0;
      const totalImages = images.length;

      const initMasonry = () => {
        const msnry = new Masonry(gridElement, {
          itemSelector: '.masonry-item',
          columnWidth: '.masonry-item',
          percentPosition: true,
          gutter: 16,
          transitionDuration: '0.3s',
        });

        // Re-layout when images load
        images.forEach((img) => {
          if (img.complete) {
            msnry.layout();
          } else {
            img.addEventListener('load', () => {
              msnry.layout();
            });
          }
        });
      };

      if (totalImages === 0) {
        initMasonry();
      } else {
        images.forEach((img) => {
          if (img.complete) {
            loadedImages++;
            if (loadedImages === totalImages) {
              initMasonry();
            }
          } else {
            img.addEventListener('load', () => {
              loadedImages++;
              if (loadedImages === totalImages) {
                initMasonry();
              }
            });
          }
        });
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonryGallery);
  } else {
    initMasonryGallery();
  }

  // Also initialize on view transitions (Astro)
  document.addEventListener('astro:after-swap', initMasonryGallery);
</script>

<style scoped>
  .masonry-grid {
    margin: 0 auto;
  }

  .masonry-item {
    width: calc(50% - 8px);
    margin-bottom: 16px;
    break-inside: avoid;
  }

  @media (max-width: 767px) {
    .masonry-item {
      width: 100%;
    }
  }

  @media (min-width: 1536px) {
    .masonry-item {
      width: calc(33.333% - 11px);
    }
  }
</style>
