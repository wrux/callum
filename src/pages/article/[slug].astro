---
import { imageBuilder } from '~/sanity/image';
import { createImageUrlBuilder } from '@sanity/image-url';
import { sanityClient } from 'sanity:client';
import SanityPicture from 'astro-sanity-picture';
import BaseLayout from '~/layouts/BaseLayout.astro';
import { DateTime, PortableText } from '~/components';
import { getPosts } from '~/sanity/queries';

// Create a cropped image builder for main images with fixed 16:9 aspect ratio
const baseCroppedBuilder = createImageUrlBuilder(sanityClient)
  .fit('crop')
  .format('webp');

// Create a proxy wrapper to ensure 16:9 aspect ratio is maintained
const croppedImageBuilder = new Proxy(baseCroppedBuilder, {
  get(target, prop) {
    if (prop === 'image') {
      return (source: any) => {
        const builder = target.image(source);
        // Override width/height methods to maintain 16:9 aspect ratio
        const originalWidth = builder.width.bind(builder);
        const originalHeight = builder.height.bind(builder);

        builder.width = function (width: number) {
          originalWidth(width);
          // Calculate height to maintain 16:9 aspect ratio
          const height = Math.round((width * 9) / 16);
          originalHeight(height);
          return this;
        };

        builder.height = function (height: number) {
          originalHeight(height);
          // Calculate width to maintain 16:9 aspect ratio
          const width = Math.round((height * 16) / 9);
          originalWidth(width);
          return this;
        };

        return builder;
      };
    }
    return (target as any)[prop];
  },
});

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

export type Props = Article;

const post = Astro.props as Article;
---

<BaseLayout
  meta={{
    title: `${post.title} | callum.co.uk`,
    description: post.excerpt,
    image:
      post.mainImage &&
      imageBuilder.image(post.mainImage).width(1600).height(900).url(),
  }}
>
  <article class="pt-24 md:pt-0">
    <section class="mb-12 md:mb-16 lg:mb-20">
      <div class="container">
        <div class="max-w-4xl mx-auto text-center py-6 md:py-8 lg:py-12">
          {
            (post?.imageCount || post?.readingTime) && (
              <p class="type-text-sm type-text-muted mb-4 lg:mb-6 uppercase tracking-wide">
                {[
                  post?.readingTime && `${post.readingTime} min read`,
                  post?.imageCount &&
                    `${post.imageCount} image${post.imageCount > 1 ? 's' : ''}`,
                ]
                  .filter(Boolean)
                  .join(' â€¢ ')}
              </p>
            )
          }
          {
            post?.countries && (
              <div class="flex gap-2 flex-wrap justify-center mb-6 lg:mb-8">
                <span class="sr-only">Countries: </span>
                {post.countries.map((country) => (
                  <span class="inline-block px-4 py-1.5 bg-gray-800 text-gray-300 rounded-full text-sm font-medium border border-gray-700">
                    {country.name}
                  </span>
                ))}
              </div>
            )
          }
          <h1 class="type-h1 mb-6 lg:mb-8">
            {post.title}
          </h1>
          {
            post?.excerpt && (
              <p class="type-text-lg mb-8 lg:mb-10 text-gray-300 max-w-3xl mx-auto">
                {post.excerpt}
              </p>
            )
          }
          <p class="type-text-sm type-text-muted text-gray-500">
            Published <DateTime date={post.publishedAt} />
          </p>
        </div>
      </div>
      <div class="w-full md:container md:max-w-screen-2xl mt-8 lg:mt-12">
        {
          post?.mainImage && (
            <figure class="md:rounded-2xl overflow-hidden shadow-2xl border-0 md:border border-gray-800">
              <div class="relative aspect-[16/9] overflow-hidden">
                <SanityPicture
                  src={post.mainImage}
                  imageUrlBuilder={croppedImageBuilder}
                  sizes="(max-width: 767px) 100vw, (max-width: 1535px) 90vw, 1344px"
                  img={{
                    alt: post.mainImage.asset.alt || post.title || '',
                    class: 'w-full h-full object-cover',
                  }}
                  loading="eager"
                />
              </div>
              {post.mainImage?.alt && (
                <figcaption class="sr-only">{post.mainImage.alt}</figcaption>
              )}
            </figure>
          )
        }
      </div>
    </section>

    <PortableText value={post.content} />
  </article>
</BaseLayout>
