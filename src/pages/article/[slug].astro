---
import { imageBuilder } from '~/sanity/image';
import SanityPicture from 'astro-sanity-picture';
import { BaseLayout } from '~/layouts';
import { DateTime, Heading, PortableText, Text } from '~/components';
import { getPosts } from '~/sanity/queries';

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

export type Props = Article;

const post = Astro.props as Article;
---

<BaseLayout
  meta={{
    title: `${post.title} | callum.co.uk`,
    description: post.excerpt,
    image:
      post.mainImage &&
      imageBuilder.image(post.mainImage).width(1600).height(900).url(),
  }}
>
  <article>
    <section class="mb-12 md:mb-16 lg:mb-20">
      <div class="container">
        <div
          class="max-w-4xl mx-auto text-center py-6 md:py-8 lg:py-12"
        >
          {
            (post?.imageCount || post?.readingTime) && (
              <Text display="muted" size="sm" class:list="mb-4 lg:mb-6 uppercase tracking-wide">
                {[
                  post?.readingTime && `${post.readingTime} min read`,
                  post?.imageCount &&
                    `${post.imageCount} image${post.imageCount > 1 ? 's' : ''}`,
                ]
                  .filter(Boolean)
                  .join(' â€¢ ')}
              </Text>
            )
          }
          {
            post?.countries && (
              <div class="flex gap-2 flex-wrap justify-center mb-6 lg:mb-8">
                <span class="sr-only">Countries: </span>
                {post.countries.map((country) => (
                  <span class="inline-block px-4 py-1.5 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium border border-gray-200 dark:border-gray-700">
                    {country.name}
                  </span>
                ))}
              </div>
            )
          }
          <Heading as="h1" size="h1" class:list="mb-6 lg:mb-8">
            {post.title}
          </Heading>
          {
            post?.excerpt && (
              <Text size="lg" class:list="mb-8 lg:mb-10 text-gray-700 dark:text-gray-300 max-w-3xl mx-auto">
                {post.excerpt}
              </Text>
            )
          }
          <Text display="muted" size="sm" class:list="text-gray-500 dark:text-gray-500">
            Published <DateTime date={post.publishedAt} />
          </Text>
        </div>
      </div>
      <div class="container max-w-screen-2xl mt-8 lg:mt-12">
        {
          post?.mainImage && (
            <figure class="rounded-2xl overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-800">
              <SanityPicture
                src={post.mainImage}
                imageUrlBuilder={imageBuilder}
                sizes="(max-width: 1535px) 90vw, 1344px"
                img={{
                  alt: post.mainImage.asset.alt || post.title || '',
                }}
                loading="eager"
              />
              {post.mainImage?.alt && (
                <figcaption class="sr-only">{post.mainImage.alt}</figcaption>
              )}
            </figure>
          )
        }
      </div>
    </section>

    <PortableText value={post.content} />
  </article>
</BaseLayout>
